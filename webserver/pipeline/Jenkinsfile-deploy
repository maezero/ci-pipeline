pipeline {

    agent any

    environment {
        APP_NAME = "webserver"
        APP_VERSION = "1.0.0"
    }

    parameters {
        string(defaultValue: "Hello World App", description: 'Package Name', name: 'PackageName')
        string(defaultValue: "X.X.X-XXX", description: 'Package Version to Deploy', name: 'PackageVersion')
    }

    options {
        buildDiscarder logRotator( 
                    daysToKeepStr: '15', 
                    numToKeepStr: '10'
            )
    }

    stages {
        stage('Deployment'){
            steps{
                    sh "echo '${PackageName} ${PackageVersion} is deployed'"

                    withKubeCredentials(kubectlCredentials: [[caCertificate: '', clusterName: '', contextName: '', credentialsId: 'eks-config', namespace: '', serverUrl: '']]) {
                        withCredentials([usernamePassword(credentialsId: 'docker-hub', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {
                            sh 'docker logout'
                            sh "docker login -u $USERNAME -p $PASSWORD"
                            sh 'kubectl create deployment webserver --image=zerozang/webserver:1.0.14 || true'
                            sh 'kubectl expose deployment webserver --type=LoadBalancer --port=8080 || true'   
                        }   
                    }
            }
        }
    }
  
}
